<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playlist Preview</title>
    <link rel="stylesheet" href="{% static 'recommender.css' %}"/>
</head>
<body>
    <div class="page-container">
        <header>
            <div class="header-inner">
                <a href="{% url 'dashboard:dashboard' %}" class="logo">AI Playlist Generator</a>
                <div class="track-count"><span id="track-count">{{ playlist_tracks|length }}</span> Tracks</div>
            </div>
        </header>
        <main>
            <div class="message-stack" id="message-stack">
                {% for message in messages %}
                    <div class="message message-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
                {% for item in errors %}
                    <div class="message message-warning">{{ item }}</div>
                {% endfor %}
            </div>

            <section class="playlist-card">
                <form id="playlist-save-form" method="post" action="{% url 'recommender:save_playlist' %}">
                    {% csrf_token %}
                    <input type="hidden" name="cache_key" value="{{ cache_key }}">
                    {% if prompt %}
                        <input type="hidden" name="prompt" value="{{ prompt }}">
                    {% endif %}
                    <div class="playlist-header">
                        {% with current_name=playlist_name|default:suggested_playlist_name %}
                            <input
                                type="text"
                                name="playlist_name"
                                id="playlist-name-input"
                                class="playlist-name-input"
                                maxlength="100"
                                placeholder="Name your playlist"
                                value="{{ current_name }}">
                        {% endwith %}
                        <div class="action-buttons">
                            <button
                                type="submit"
                                class="btn btn-ghost"
                                formaction="{% url 'recommender:remix_playlist' %}"
                                formmethod="post"
                                id="remix-button"
                                {% if not cache_key or not playlist_tracks %}disabled{% endif %}>
                                Remix Playlist
                            </button>
                            <button type="submit" class="btn btn-primary" id="save-playlist-button">
                                Save to Spotify
                            </button>
                        </div>
                    </div>
                </form>

                <div class="search-bar">
                    <input
                        type="text"
                        class="search-input"
                        placeholder="Search to add songs (coming soon)"
                        disabled>
                    <span class="coming-soon-note">Manual additions will arrive in a future update.</span>
                </div>

                {% if playlist_stats %}
                    <section class="playlist-stats">
                        <h3>Playlist Analytics</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <span class="stat-label">Total Tracks</span>
                                <span class="stat-value">{{ playlist_stats.total_tracks }}</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-label">Total Duration</span>
                                <span class="stat-value">{{ playlist_stats.total_duration }}</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-label">Average Popularity</span>
                                <span class="stat-value">
                                    {% if playlist_stats.avg_popularity is not None %}
                                        {{ playlist_stats.avg_popularity }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-label">Novelty</span>
                                <span class="stat-value">{{ playlist_stats.novelty }}%</span>
                            </div>
                        </div>
                        {% if playlist_stats.genre_distribution %}
                            <h4>Genre Distribution</h4>
                            <ul class="genre-breakdown">
                                {% for genre, pct in playlist_stats.genre_distribution.items %}
                                    <li>
                                        <span class="genre-label">{{ genre|title }}</span>
                                        <span class="genre-value">{{ pct }}%</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </section>
                {% endif %}

                <ul
                    class="track-list"
                    id="track-list"
                    data-cache-key="{{ cache_key }}"
                    data-update-url="{% url 'recommender:update_cached_playlist' %}">
                    {% for track in playlist_tracks %}
                        <li
                            class="track-item"
                            data-track-id="{{ track.id }}"
                            data-position="{{ forloop.counter0 }}">
                            <div class="track-artwork">
                                {% if track.album_image_url %}
                                    <img src="{{ track.album_image_url }}" alt="Album artwork for {{ track.name }}">
                                {% else %}
                                    {{ track.name|default:"?"|slice:":1" }}
                                {% endif %}
                            </div>
                            <div class="track-info">
                                <span class="track-name">{{ track.name }}</span>
                                <span class="track-artist">{{ track.artists }}</span>
                                {% if track.album_name %}
                                    <span class="track-album">{{ track.album_name }}</span>
                                {% endif %}
                            </div>
                            <div class="track-meta">
                                <span
                                    class="track-duration"
                                    data-duration-ms="{{ track.duration_ms|default:0 }}">--:--</span>
                                <button
                                    type="button"
                                    class="remove-track-button">
                                    Remove
                                </button>
                            </div>
                        </li>
                    {% empty %}
                        <li class="empty-state" id="empty-state">
                            No tracks available yet. Use Remix to generate a new set.
                        </li>
                    {% endfor %}
                </ul>
            </section>

            {% if debug_enabled %}
                <section class="debug-panel">
                    <h3>Debug Inspector</h3>

                    <div class="debug-meta">
                        <div class="debug-meta-row">
                            <span class="debug-meta-label">Prompt</span>
                            <span class="debug-meta-value">{{ prompt|default:"—" }}</span>
                        </div>
                        {% if attributes %}
                            <div class="debug-meta-row">
                                <span class="debug-meta-label">Attributes</span>
                                <span class="debug-meta-value">
                                    {% for key, value in attributes.items %}
                                        <span class="debug-chip">{{ key }}: {{ value|default:"—" }}</span>
                                    {% empty %}
                                        <span class="debug-meta-value">—</span>
                                    {% endfor %}
                                </span>
                            </div>
                        {% endif %}
                        {% if seed_source_counts %}
                            <div class="debug-meta-row">
                                <span class="debug-meta-label">Seed Sources</span>
                                <span class="debug-meta-value">
                                    {% for source, count in seed_source_counts.items %}
                                        <span class="debug-chip">{{ source }}: {{ count }}</span>
                                    {% endfor %}
                                </span>
                            </div>
                        {% endif %}
                        {% if prompt_artist_candidates %}
                            <div class="debug-meta-row">
                                <span class="debug-meta-label">Prompt Artists</span>
                                <span class="debug-meta-value">{{ prompt_artist_candidates|join:", " }}</span>
                            </div>
                        {% endif %}
                        {% if llm_provider %}
                            <div class="debug-meta-row">
                                <span class="debug-meta-label">LLM Provider</span>
                                <span class="debug-meta-value">{{ llm_provider|capfirst }}</span>
                            </div>
                        {% endif %}
                    </div>

                    <details class="debug-details" open>
                        <summary>Seed Inventory ({{ seed_track_details|length }})</summary>
                        {% if seed_track_details %}
                            <table class="debug-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Track</th>
                                        <th>Artists</th>
                                        <th>Source</th>
                                        <th>Year</th>
                                        <th>Popularity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for track in seed_track_details %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>
                                                <div>{{ track.name|default:"(unknown track)" }}</div>
                                                {% if track.id %}
                                                    <div class="debug-track-meta">ID: {{ track.id }}</div>
                                                {% endif %}
                                            </td>
                                            <td>{{ track.artists|default:"—" }}</td>
                                            <td>{{ track.seed_source|default:track.source|default:"—" }}</td>
                                            <td>{{ track.year|default:"—" }}</td>
                                            <td>{{ track.popularity|default:"—" }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="debug-empty">No seed tracks recorded.</p>
                        {% endif %}
                    </details>

                    <details class="debug-details" open>
                        <summary>Similarity Scores ({{ similar_track_details|length }})</summary>
                        {% if similar_track_details %}
                            <table class="debug-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Track</th>
                                        <th>Artists</th>
                                        <th>Score</th>
                                        <th>Breakdown</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for track in similar_track_details %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>
                                                <div>{{ track.name|default:"(unknown track)" }}</div>
                                                {% if track.id %}
                                                    <div class="debug-track-meta">ID: {{ track.id }}</div>
                                                {% endif %}
                                            </td>
                                            <td>{{ track.artists|default:"—" }}</td>
                                            <td>
                                                <div class="score-cell">
                                                    <span class="score-badge">{{ track.score|default:0|floatformat:3 }}</span>
                                                    {% if track.popularity %}
                                                        <span class="flag-chip popularity">Pop {{ track.popularity }}</span>
                                                    {% endif %}
                                                    {% if track.seed_artist_overlap %}
                                                        <span class="flag-chip seed">Seed overlap</span>
                                                    {% endif %}
                                                    {% if track.focus_artist_overlap %}
                                                        <span class="flag-chip focus">Focus artist</span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                {% if track.score_breakdown %}
                                                    <div class="breakdown-list">
                                                        {% for key, value in track.score_breakdown.items %}
                                                            {% if key != 'total' and value %}
                                                                <span class="breakdown-pill">{{ key }}: {{ value|floatformat:3 }}</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                        {% if track.score_breakdown.total %}
                                                            <span class="breakdown-pill breakdown-total">total: {{ track.score_breakdown.total|floatformat:3 }}</span>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <span class="debug-empty">No breakdown recorded.</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="debug-empty">No similarity candidates were ranked.</p>
                        {% endif %}
                    </details>

                    {% if profile_snapshot %}
                        <details class="debug-details">
                            <summary>User Profile Cache Snapshot ({{ profile_snapshot.sample_size|default:0 }} tracks)</summary>
                            <div class="debug-meta">
                                <div class="debug-meta-row">
                                    <span class="debug-meta-label">Source</span>
                                    <span class="debug-meta-value">{{ profile_snapshot.source|default:"—" }}</span>
                                </div>
                                <div class="debug-meta-row">
                                    <span class="debug-meta-label">Captured</span>
                                    <span class="debug-meta-value">{{ profile_snapshot.created_at|default:"—" }}</span>
                                </div>
                            </div>

                            {% if profile_snapshot.top_tracks %}
                                <h4 style="margin-top: 12px; font-size: 0.95rem; color: rgba(255, 255, 255, 0.85);">Top Cached Tracks</h4>
                                <ul class="debug-list">
                                    {% for track in profile_snapshot.top_tracks %}
                                        <li>{{ track.name|default:"(unknown)" }} — {{ track.artists|default:"—" }} (pop {{ track.popularity|default:0 }}, {{ track.year|default:"—" }})</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}

                            {% if profile_snapshot.top_artists %}
                                <h4 style="margin-top: 16px; font-size: 0.95rem; color: rgba(255, 255, 255, 0.85);">Top Artists by Play Count</h4>
                                <ul class="debug-list">
                                    {% for artist in profile_snapshot.top_artists %}
                                        <li>{{ artist.name|default:artist.id }} — {{ artist.play_count|default:0 }} plays{% if artist.genres %} <span class="debug-chip">{{ artist.genres|join:", " }}</span>{% endif %}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}

                            {% if profile_snapshot.genres %}
                                <h4 style="margin-top: 16px; font-size: 0.95rem; color: rgba(255, 255, 255, 0.85);">Genre Buckets</h4>
                                {% for genre in profile_snapshot.genres %}
                                    <details class="debug-subdetails">
                                        <summary>{{ genre.genre|default:"(unknown genre)" }} · {{ genre.track_count|default:0 }} tracks</summary>
                                        <div class="debug-meta-row">
                                            <span class="debug-meta-label">Avg Popularity</span>
                                            <span class="debug-meta-value">{{ genre.avg_popularity|default:"—" }}</span>
                                        </div>
                                        <div class="debug-meta-row">
                                            <span class="debug-meta-label">Avg Year</span>
                                            <span class="debug-meta-value">{{ genre.avg_year|default:"—" }}</span>
                                        </div>
                                        {% if genre.tracks %}
                                            <ul class="debug-list">
                                                {% for track in genre.tracks %}
                                                    <li>{{ track.name|default:"(unknown)" }} — {{ track.artists|default:"—" }} (pop {{ track.popularity|default:0 }}, {{ track.year|default:"—" }})</li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <p class="debug-empty">No cached tracks recorded for this genre.</p>
                                        {% endif %}
                                    </details>
                                {% endfor %}
                            {% endif %}
                        </details>
                    {% endif %}

                    {% if debug_steps %}
                        <details class="debug-details">
                            <summary>Generation Log ({{ debug_steps|length }})</summary>
                            <ol class="debug-steps">
                                {% for step in debug_steps %}
                                    <li>{{ step }}</li>
                                {% endfor %}
                            </ol>
                        </details>
                    {% endif %}
                </section>
            {% endif %}
        </main>
    </div>

    <div class="remix-overlay" id="remix-overlay" data-total-steps="24">
        <div class="remix-modal">
            <div class="remix-loader-ring"></div>
            <h3>Remixing Your Playlist</h3>
            <div class="remix-progress">
                <div class="remix-progress-bar" id="remix-progress-bar"></div>
            </div>
            <div class="remix-progress-label" id="remix-progress-label">Preparing remix...</div>
        </div>
    </div>

    <script>
        (function () {
            const trackList = document.getElementById('track-list');
            const saveButton = document.getElementById('save-playlist-button');
            const messageStack = document.getElementById('message-stack');
            const cacheKey = trackList ? trackList.dataset.cacheKey : null;
            const updateUrl = trackList ? trackList.dataset.updateUrl : null;
            const remixOverlay = document.getElementById('remix-overlay');
            const remixProgressBar = document.getElementById('remix-progress-bar');
            const remixProgressLabel = document.getElementById('remix-progress-label');
            const remixButton = document.getElementById('remix-button');
            const playlistForm = document.getElementById('playlist-save-form');

            if (playlistForm && remixButton && remixOverlay && remixProgressBar && remixProgressLabel) {
                let remixFrame = null;

                const resetRemixProgress = () => {
                    if (remixFrame !== null) {
                        cancelAnimationFrame(remixFrame);
                        remixFrame = null;
                    }
                    remixProgressBar.style.width = '0%';
                    remixProgressLabel.textContent = 'Preparing remix...';
                };

                const holdNearCompletion = (label) => {
                    if (!remixOverlay.classList.contains('visible')) {
                        resetRemixProgress();
                        return;
                    }
                    const flicker = 94 + Math.random() * 2;
                    remixProgressBar.style.width = `${flicker}%`;
                    remixProgressLabel.textContent = `${label} (waiting on Spotify...)`;
                    remixFrame = requestAnimationFrame(() => holdNearCompletion(label));
                };

                const startRemixProgress = () => {
                    const totalSteps = Number(remixOverlay.dataset.totalSteps || 24);
                    const phaseTimeline = [
                        { label: 'Studying current mix', duration: 1200, target: 0.08 },
                        { label: 'Spotlighting standout tracks', duration: 12500, target: 0.2 },
                        { label: 'Hunting fresh vibes', duration: 58000, target: 0.72 },
                        { label: 'Resolving Spotify matches', duration: 5500, target: 0.88 },
                        { label: 'Balancing energy arcs', duration: 4200, target: 0.94 },
                        { label: 'Sequencing transitions', duration: 2600, target: 0.97 },
                    ];
                    const finalLabel = 'Locking in remix order';
                    const totalDuration = phaseTimeline.reduce((sum, phase) => sum + phase.duration, 0);
                    const startTime = performance.now();

                    const animate = () => {
                        if (!remixOverlay.classList.contains('visible')) {
                            resetRemixProgress();
                            return;
                        }

                        const elapsed = performance.now() - startTime;
                        const clampedElapsed = Math.min(elapsed, totalDuration);

                        let accumulated = 0;
                        let previousTarget = 0;
                        let currentLabel = phaseTimeline[phaseTimeline.length - 1].label;
                        let progressRatio = phaseTimeline[phaseTimeline.length - 1].target;

                        for (const phase of phaseTimeline) {
                            const phaseStart = accumulated;
                            const phaseEnd = accumulated + phase.duration;
                            if (clampedElapsed <= phaseEnd) {
                                const localProgress = Math.min(
                                    (clampedElapsed - phaseStart) / phase.duration,
                                    1
                                );
                                progressRatio =
                                    previousTarget + (phase.target - previousTarget) * (1 - Math.pow(1 - localProgress, 2));
                                currentLabel = phase.label;
                                break;
                            }
                            accumulated = phaseEnd;
                            previousTarget = phase.target;
                        }

                        const percentage = Math.max(1, Math.floor(progressRatio * 100));
                        remixProgressBar.style.width = `${percentage}%`;

                        const stepNumber = Math.max(
                            1,
                            Math.min(totalSteps, Math.round(progressRatio * totalSteps))
                        );
                        remixProgressLabel.textContent = `${currentLabel} (${stepNumber}/${totalSteps})`;

                        if (clampedElapsed < totalDuration) {
                            remixFrame = requestAnimationFrame(animate);
                        } else {
                            remixFrame = requestAnimationFrame(() => holdNearCompletion(finalLabel));
                        }
                    };

                    animate();
                };

                remixButton.addEventListener('click', () => {
                    if (remixButton.disabled) {
                        return;
                    }
                    remixOverlay.classList.add('visible');
                    resetRemixProgress();
                    startRemixProgress();
                });

                playlistForm.addEventListener('submit', (event) => {
                    const submitter = event.submitter || document.activeElement;
                    if (submitter !== remixButton) {
                        remixOverlay.classList.remove('visible');
                        resetRemixProgress();
                    }
                });

                window.addEventListener('pagehide', () => {
                    resetRemixProgress();
                    remixOverlay.classList.remove('visible');
                });
            }

            function formatDuration(ms) {
                const totalSeconds = Math.max(0, Math.floor(Number(ms) / 1000));
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            function refreshDurations() {
                if (!trackList) {
                    return;
                }
                const durations = trackList.querySelectorAll('[data-duration-ms]');
                durations.forEach((node) => {
                    const ms = Number(node.dataset.durationMs || 0);
                    node.textContent = ms > 0 ? formatDuration(ms) : '--:--';
                });
            }

            function updateTrackPositions() {
                if (!trackList) {
                    return;
                }
                const items = trackList.querySelectorAll('.track-item');
                items.forEach((item, index) => {
                    item.dataset.position = String(index);
                });
            }

            function setTrackCount(count) {
                const counter = document.getElementById('track-count');
                if (counter) {
                    counter.textContent = String(count);
                }
                if (saveButton) {
                    saveButton.disabled = count === 0;
                }
                const emptyState = document.getElementById('empty-state');
                if (count === 0) {
                    if (!emptyState) {
                        const placeholder = document.createElement('li');
                        placeholder.id = 'empty-state';
                        placeholder.className = 'empty-state';
                        placeholder.textContent = 'No tracks available yet. Use Remix to generate a new set.';
                        trackList.appendChild(placeholder);
                    }
                } else if (emptyState) {
                    emptyState.remove();
                }
            }

            function pushMessage(kind, text) {
                if (!messageStack) {
                    return;
                }
                const node = document.createElement('div');
                node.className = `message message-${kind}`;
                node.textContent = text;
                messageStack.appendChild(node);
            }

            function getCsrfToken() {
                const tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                return tokenInput ? tokenInput.value : '';
            }

            if (trackList && cacheKey && updateUrl) {
                trackList.addEventListener('click', (event) => {
                    const button = event.target.closest('.remove-track-button');
                    if (!button) {
                        return;
                    }
                    const item = button.closest('.track-item');
                    if (!item) {
                        return;
                    }
                    const trackId = item.dataset.trackId || '';
                    const position = Number(item.dataset.position || 0);
                    button.disabled = true;

                    fetch(updateUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            action: 'remove',
                            cache_key: cacheKey,
                            track_id: trackId,
                            position,
                        }),
                    })
                        .then((response) => {
                            if (!response.ok) {
                                throw new Error('Request failed');
                            }
                            return response.json();
                        })
                        .then((payload) => {
                            if (payload.status !== 'ok') {
                                throw new Error(payload.error || 'Unable to update playlist.');
                            }
                            item.remove();
                            updateTrackPositions();
                            setTrackCount(payload.track_count || 0);
                            pushMessage('success', 'Track removed from the playlist.');
                        })
                        .catch((error) => {
                            button.disabled = false;
                            pushMessage('error', error.message || 'Failed to remove track. Try again.');
                        });
                });
            }

            refreshDurations();
            if (trackList) {
                setTrackCount(trackList.querySelectorAll('.track-item').length);
            }
        })();
    </script>
</body>
</html>
