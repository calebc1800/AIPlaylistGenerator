<!-- Update src/explorer/templates/explorer/partials/playlist_card.html -->
<div class="playlist-card">
    <div class="playlist-image">
        {% if playlist.cover_image %}
        <img src="{{ playlist.cover_image }}" alt="{{ playlist.playlist_name }}">
        {% else %}
        üéµ
        {% endif %}
    </div>
    <div class="playlist-info-compact">
        <div class="playlist-title">{{ playlist.playlist_name }}</div>
        <div class="playlist-meta">
            <span class="creator-name">
                üë§ 
                <a href="#" 
                   class="creator-link" 
                   data-user-id="{{ playlist.creator_user_id }}"
                   data-user-name="{{ playlist.creator_display_name }}">
                    {{ playlist.creator_display_name }}
                </a>
            </span>
            <form method="POST" action="{% url 'like_playlist' playlist.playlist_id %}" class="like-form" style="display: inline;">
                <button type="submit" class="like-button" data-playlist-id="{{ playlist.playlist_id }}">
            <span class="creator-name">üë§ {{ playlist.creator_display_name }}</span>
            {% if user_id %}
            <form method="POST" action="/explorer/playlist/{{ user_id }}/{{ playlist.playlist_id }}/like/" class="like-form" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="like-button" data-user-id="{{ user_id }}" data-playlist-id="{{ playlist.playlist_id }}">
                    <span class="likes-count">{{ playlist.like_count }}</span> üëç
                </button>
            </form>
            {% else %}
            <span class="like-disabled" title="Login to like playlists" style="opacity: 0.6; cursor: not-allowed;">
                <span class="likes-count">{{ playlist.like_count }}</span> üëç
            </span>
            {% endif %}
        </div>
        {% if playlist.spotify_uri %}
        <a href="https://open.spotify.com/playlist/{{ playlist.playlist_id }}" target="_blank" class="spotify-link">View on Spotify ‚Üí</a>
        {% endif %}
        <button class="follow-creator-btn" 
                data-user-id="{{ playlist.creator_user_id }}"
                data-user-name="{{ playlist.creator_display_name }}"
                style="margin-top: 8px;">
            Follow Creator
        </button>
    </div>
</div>

<style>
.creator-link {
    color: #42a5f5;
    text-decoration: none;
    transition: color 0.2s ease;
}

.creator-link:hover {
    color: #64B5F6;
    text-decoration: underline;
}

.follow-creator-btn {
    width: 100%;
    background: rgba(2, 136, 209, 0.1);
    border: 1px solid rgba(2, 136, 209, 0.3);
    color: #42a5f5;
    padding: 8px 16px;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.follow-creator-btn:hover {
    background: rgba(2, 136, 209, 0.2);
    border-color: rgba(2, 136, 209, 0.5);
}

.follow-creator-btn.following {
    background: rgba(46, 204, 113, 0.1);
    border-color: rgba(46, 204, 113, 0.3);
    color: #2ecc71;
}
</style>

<script>
(function() {
    // Handle follow button clicks
    document.addEventListener('click', async function(e) {
        const followBtn = e.target.closest('.follow-creator-btn');
        if (!followBtn) return;
        
        e.preventDefault();
        const userId = followBtn.dataset.userId;
        const userName = followBtn.dataset.userName;
        const currentUserId = "{{ user_id }}"; // Make sure this is available in context
        
        if (userId === currentUserId) {
            alert("You can't follow yourself!");
            return;
        }
        
        try {
            const response = await fetch('/dashboard/api/follow/toggle/', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    following_user_id: userId,
                    following_display_name: userName
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || 'Failed to toggle follow');
            }

            const data = await response.json();

            if (data.following) {
                followBtn.classList.add('following');
                followBtn.textContent = 'Following ‚úì';
            } else {
                followBtn.classList.remove('following');
                followBtn.textContent = 'Follow Creator';
            }
        } catch (error) {
            console.error('Error toggling follow:', error);
            alert(error.message || 'Failed to update follow status');
        }
    });
    
    // Handle creator link clicks to open profile modal
    document.addEventListener('click', function(e) {
        const creatorLink = e.target.closest('.creator-link');
        if (!creatorLink) return;
        
        e.preventDefault();
        const userId = creatorLink.dataset.userId;
        const userName = creatorLink.dataset.userName;
        
        // Trigger the user profile modal if on dashboard
        const event = new CustomEvent('openUserProfile', {
            detail: { userId, userName }
        });
        window.dispatchEvent(event);
    });
    
    function getCsrfToken() {
        const tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        return tokenInput ? tokenInput.value : '';
    }
})();
</script>
